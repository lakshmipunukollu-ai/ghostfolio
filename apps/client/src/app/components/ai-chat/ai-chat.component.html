<!-- Floating trigger button -->
<button
  aria-label="Open Portfolio Assistant"
  class="ai-fab"
  [class.ai-fab--open]="isOpen"
  (click)="togglePanel()"
>
  <span class="ai-fab__icon">ğŸ¤–</span>
  <span class="ai-fab__label" [class.ai-fab__label--hidden]="isOpen"
    >Ask AI</span
  >
</button>

<!-- Slide-in panel -->
<div
  aria-label="Portfolio Assistant"
  class="ai-panel"
  role="complementary"
  [class.ai-panel--visible]="isOpen"
>
  <!-- Panel header -->
  <div class="ai-panel__header">
    <div class="ai-panel__header-left">
      <span class="ai-panel__avatar">ğŸ¤–</span>
      <div>
        <span class="ai-panel__title">Portfolio Assistant</span>
        <span class="ai-panel__subtitle">
          Powered by Claude
          <span
            class="ai-status-dot"
            [class.ai-status-dot--offline]="agentReachable === false"
            [class.ai-status-dot--online]="agentReachable === true"
            [title]="
              agentReachable === true
                ? 'Agent online'
                : agentReachable === false
                  ? 'Agent offline'
                  : 'Checkingâ€¦'
            "
          ></span>
        </span>
      </div>
    </div>
    <div class="ai-panel__header-actions">
      <button
        aria-label="Clear chat history"
        class="ai-clear-btn"
        title="Clear chat history"
        (click)="clearHistory()"
      >
        Clear
      </button>
      <button aria-label="Close" class="ai-panel__close" (click)="closePanel()">
        âœ•
      </button>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="ai-tabs">
    <button
      class="ai-tab"
      [class.ai-tab--active]="activeTab === 'chat'"
      (click)="switchTab('chat')"
    >
      ğŸ’¬ Chat
    </button>
    @if (enableRealEstate) {
      <button
        class="ai-tab"
        [class.ai-tab--active]="activeTab === 'log'"
        (click)="switchTab('log')"
      >
        ğŸ“Š Activity Log
      </button>
    }
  </div>

  <!-- Success banner -->
  @if (successBanner) {
    <div class="ai-banner ai-banner--success">{{ successBanner }}</div>
  }

  <!-- Activity log view -->
  @if (activeTab === 'log') {
    <div class="ai-log">
      <!-- Stats bar -->
      <div class="ai-log__stats">
        <span>{{ activityStats?.total_invocations ?? 0 }} calls</span>
        <span class="ai-log__dot">Â·</span>
        <span>avg {{ avgLatency() }}</span>
        <span class="ai-log__dot">Â·</span>
        <span>{{ successRate() }} success</span>
        @if (isLoadingLog) {
          <span class="ai-log__refreshing">â†»</span>
        }
      </div>

      <!-- Log entries -->
      @if (activityLog.length === 0 && !isLoadingLog) {
        <div class="ai-log__empty">
          <span>No tool calls yet â€” start chatting</span>
          <span class="ai-log__empty-hint"
            >Real estate queries appear here in real time</span
          >
        </div>
      }
      @if (activityLog.length > 0) {
        <div class="ai-log__table-wrap">
          <table class="ai-log__table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Tool</th>
                <th>Query</th>
                <th>ms</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (entry of activityLog; track entry.timestamp) {
                <tr [class.ai-log__row--fail]="!entry.success">
                  <td class="ai-log__time">
                    {{ logEntryTime(entry.timestamp) }}
                  </td>
                  <td class="ai-log__fn">
                    {{ entry.function.replace('_', ' ') }}
                  </td>
                  <td class="ai-log__query" [title]="entry.query">
                    {{ entry.query }}
                  </td>
                  <td class="ai-log__ms">
                    {{ entry.duration_ms | number: '1.0-0' }}
                  </td>
                  <td class="ai-log__status">
                    {{ entry.success ? 'âœ“' : 'âœ—' }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  }

  <!-- Empty portfolio seed banner -->
  @if (activeTab === 'chat' && showSeedBanner && !isSeeding) {
    <div class="ai-banner ai-banner--seed">
      <span>Your portfolio is empty. Load demo data to try the AI?</span>
      <div class="ai-banner__actions">
        <button
          class="ai-banner__btn ai-banner__btn--primary"
          (click)="seedPortfolio()"
        >
          ğŸŒ± Load demo data
        </button>
        <button
          class="ai-banner__btn ai-banner__btn--dismiss"
          (click)="showSeedBanner = false"
        >
          Dismiss
        </button>
      </div>
    </div>
  }
  @if (isSeeding) {
    <div class="ai-banner ai-banner--seed">â³ Loading demo portfolioâ€¦</div>
  }

  <!-- Chat view -->
  @if (activeTab === 'chat') {
    <!-- Messages area -->
    <div #messagesContainer class="ai-messages">
      @for (msg of messages; track $index; let i = $index) {
        <div
          class="ai-message"
          [class.ai-message--assistant]="msg.role === 'assistant'"
          [class.ai-message--user]="msg.role === 'user'"
        >
          <!-- Bubble -->
          <div class="ai-bubble" [innerHTML]="msg.content | aiMarkdown"></div>

          <!-- Copy button for assistant messages -->
          @if (msg.role === 'assistant') {
            <button
              class="ai-copy-btn"
              (click)="copyToClipboard(msg.content, i)"
              [title]="copySuccessMap[i] ? 'Copied!' : 'Copy response'"
            >
              @if (!copySuccessMap[i]) {
                <span>â˜ Copy</span>
              } @else {
                <span>âœ“ Copied!</span>
              }
            </button>
          }

          <!-- Real estate comparison card -->
          @if (msg.comparisonCard) {
            <gf-real-estate-card [card]="msg.comparisonCard" />
          }

          <!-- Portfolio allocation chart -->
          @if (msg.chartData) {
            <gf-portfolio-chart [chartData]="msg.chartData" />
          }

          <!-- Assistant metadata row -->
          @if (msg.role === 'assistant' && msg.confidence !== undefined) {
            <div class="ai-meta">
              <!-- Low confidence warning -->
              @if (msg.confidence < 0.6) {
                <div class="ai-meta__warning">
                  âš ï¸ Low confidence â€” some data may be incomplete
                </div>
              }

              <div class="ai-meta__row">
                <!-- Confidence badge -->
                <span
                  class="ai-badge"
                  [class]="confidenceClass(msg.confidence)"
                >
                  {{ confidenceLabel(msg.confidence) }} ({{
                    (msg.confidence * 100).toFixed(0)
                  }}%)
                </span>

                <!-- Tools used chips -->
                @for (tool of msg.toolsUsed; track tool) {
                  <span class="ai-chip"
                    >{{ toolIcon(tool) }} {{ toolLabel(tool) }}</span
                  >
                }

                <!-- Latency -->
                <span class="ai-meta__latency"
                  >{{ msg.latency?.toFixed(1) }}s</span
                >

                <!-- Feedback -->
                <div class="ai-feedback">
                  <button
                    aria-label="Thumbs up"
                    class="ai-feedback__btn"
                    [class.ai-feedback__btn--active-up]="
                      msg.feedbackGiven === 1
                    "
                    [disabled]="msg.feedbackGiven !== null"
                    (click)="giveFeedback($index, 1)"
                  >
                    ğŸ‘
                  </button>
                  <button
                    aria-label="Thumbs down"
                    class="ai-feedback__btn"
                    [class.ai-feedback__btn--active-down]="
                      msg.feedbackGiven === -1
                    "
                    [disabled]="msg.feedbackGiven !== null"
                    (click)="giveFeedback($index, -1)"
                  >
                    ğŸ‘
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- Typing indicator -->
      @if (isThinking) {
        <div class="ai-message ai-message--assistant">
          <div class="ai-bubble ai-bubble--typing">
            <span class="ai-dot"></span>
            <span class="ai-dot"></span>
            <span class="ai-dot"></span>
          </div>
        </div>
      }
    </div>

    <!-- Suggestion chips (visible only before first user message) -->
    @if (showSuggestions && !isThinking) {
      <div class="ai-suggestions">
        <!-- Row 1: Portfolio chips â€” always shown -->
        <div class="ai-suggestions__row">
          <button
            class="ai-suggestion-chip"
            (click)="clickChip('How is my portfolio doing?')"
          >
            ğŸ“ˆ My portfolio performance
          </button>
          <button
            class="ai-suggestion-chip"
            (click)="clickChip('Do I have any concentration risk?')"
          >
            âš ï¸ Any concentration risk?
          </button>
          <button
            class="ai-suggestion-chip"
            (click)="clickChip('Estimate my taxes for this year')"
          >
            ğŸ’° Estimate my taxes
          </button>
        </div>
        <!-- Row 2: Property Tracking chips â€” only when feature flag is on -->
        @if (enableRealEstate) {
          <div class="ai-suggestions__row ai-suggestions__row--realestate">
            <button
              class="ai-suggestion-chip ai-suggestion-chip--re"
              (click)="
                clickChip(
                  'I want to add my home to track my equity. Walk me through it.'
                )
              "
            >
              ğŸ  Add my home to track equity
            </button>
            <button
              class="ai-suggestion-chip ai-suggestion-chip--re"
              (click)="
                clickChip(
                  'Show me my total net worth including my investments and any real estate I\'ve added.'
                )
              "
            >
              ğŸ“Š Show my total net worth
            </button>
            <button
              class="ai-suggestion-chip ai-suggestion-chip--re"
              (click)="
                clickChip(
                  'I want to understand my options for my home equity. What can I do with it?'
                )
              "
            >
              ğŸ’° What are my equity options?
            </button>
          </div>
          <!-- Row 3: Life Decisions chips -->
          <div class="ai-suggestions__row ai-suggestions__row--wealth">
            <button
              class="ai-suggestion-chip ai-suggestion-chip--wealth"
              (click)="
                clickChip('Can my portfolio fund a down payment on a house?')
              "
            >
              ğŸ’° Can my portfolio buy a house?
            </button>
            <button
              class="ai-suggestion-chip ai-suggestion-chip--wealth"
              (click)="
                clickChip(
                  'I have a job offer for $180k in Seattle. I currently make $120k in Austin. Is it worth it?'
                )
              "
            >
              âœˆï¸ I have a job offer â€” is it worth it?
            </button>
            <button
              class="ai-suggestion-chip ai-suggestion-chip--wealth"
              (click)="
                clickChip(
                  'How long until I feel financially stable if I move to Denver?'
                )
              "
            >
              ğŸŒ How long until I'm stable if I move?
            </button>
          </div>
          <!-- Row 4: Strategy chips -->
          <div class="ai-suggestions__row ai-suggestions__row--life">
            <button
              class="ai-suggestion-chip ai-suggestion-chip--life"
              (click)="
                clickChip('Am I ahead or behind financially for my age?')
              "
            >
              ğŸ“Š Am I ahead or behind financially?
            </button>
            <button
              class="ai-suggestion-chip ai-suggestion-chip--life"
              (click)="clickChip('Can I afford to have kids?')"
            >
              ğŸ‘¶ Can I afford to have kids?
            </button>
            <button
              class="ai-suggestion-chip ai-suggestion-chip--life"
              (click)="
                clickChip(
                  'What if I buy a home every 2 years for the next 10 years and rent the previous one each time? I want to use moderate assumptions â€” 4% appreciation, 8% rent yield. Walk me through the projection.'
                )
              "
            >
              ğŸ˜ï¸ What if I buy a house every 2 years?
            </button>
          </div>
        }
      </div>
    }

    <!-- Confirmation buttons (shown when awaiting yes/no) -->
    @if (awaitingConfirmation && !isThinking) {
      <div class="ai-confirm-bar">
        <span class="ai-confirm-bar__label">Confirm this transaction?</span>
        <button
          class="ai-confirm-bar__btn ai-confirm-bar__btn--yes"
          (click)="confirmWrite()"
        >
          âœ… Confirm
        </button>
        <button
          class="ai-confirm-bar__btn ai-confirm-bar__btn--no"
          (click)="cancelWrite()"
        >
          âŒ Cancel
        </button>
      </div>
    }

    <!-- Input area -->
    @if (!awaitingConfirmation || isThinking) {
      <div class="ai-input-area">
        <textarea
          #inputField
          class="ai-input"
          placeholder="Ask about your portfolio..."
          rows="1"
          [disabled]="isThinking"
          [(ngModel)]="inputValue"
          (keydown)="onKeydown($event)"
        ></textarea>
        <button
          aria-label="Send"
          class="ai-send"
          [disabled]="isThinking || !inputValue.trim()"
          (click)="sendMessage()"
        >
          @if (isThinking) {
            <span class="ai-send__spinner"></span>
          } @else {
            <svg fill="currentColor" height="18" viewBox="0 0 24 24" width="18">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          }
        </button>
      </div>
    }
  }
  <!-- end @if activeTab === 'chat' -->
</div>

<!-- Backdrop (mobile) -->
@if (isOpen) {
  <div class="ai-backdrop" (click)="closePanel()"></div>
}
